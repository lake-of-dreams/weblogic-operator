# The container definition we want to use for developing our app
box: oraclelinux:7.3

build:
  box: golang
  steps:
   - setup-go-workspace:
      package-dir: weblogic-operator

   - script:
      name: install go tools
      code: |
       go version
       go get -u -v github.com/golang/dep
       go get -u -v github.com/golang/dep/cmd/dep

   - script:
      name: install dependencies
      code: |
       dep ensure
       cd `pwd`/../../../
       git clone https://github.com/sczachariah/weblogic-operator.git weblogic-operator
       cd /go/src/weblogic-operator
       make vendor
       set GOROOT=/usr/local/go
       set GOPATH=$HOME/go
       set GOBIN=$GOPATH/bin
       set PATH=$GOPATH:$GOBIN:$PATH

   # Statically build the project
   - script:
      name: build the project
      code: |
       make build

       set OPERATOR_DOCKER_IMAGE_NAME = "weblogic-operator"
       set OPERATOR_DOCKER_IMAGE_TAG = $(shell date +%y%m%d%H%M)
       sed "s/{{VERSION}}/$(OPERATOR_DOCKER_IMAGE_TAG)/g" manifests/weblogic-operator-template.yaml > manifests/weblogic-operator.yaml

       curl -fsSLO https://get.docker.com/builds/Linux/x86_64/docker-17.03.1-ce.tgz35 && \
               tar --strip-components=1 -xvzf docker-17.03.1-ce.tgz -C /usr/local/bin
       docker build -v /var/run/docker.sock:/var/run/docker.sock -t ${OPERATOR_DOCKER_IMAGE_NAME}:${OPERATOR_DOCKER_IMAGE_TAG} -f Dockerfile

   - internal/shell:
      cmd: /bin/sh  #defaults to /bin/bash
      code: |
        # some code to automatically run in your shell session before you start interacting
        set OPERATOR_DOCKER_IMAGE_NAME = "weblogic-operator"
        set OPERATOR_DOCKER_IMAGE_TAG = $(shell date +%y%m%d%H%M)
        sed "s/{{VERSION}}/$(OPERATOR_DOCKER_IMAGE_TAG)/g" manifests/weblogic-operator-template.yaml > manifests/weblogic-operator.yaml

        curl -fsSLO https://get.docker.com/builds/Linux/x86_64/docker-17.03.1-ce.tgz35 && \
        tar --strip-components=1 -xvzf docker-17.03.1-ce.tgz -C /usr/local/bin
        docker build -v /var/run/docker.sock:/var/run/docker.sock -t ${OPERATOR_DOCKER_IMAGE_NAME}:${OPERATOR_DOCKER_IMAGE_TAG} -f Dockerfile

   - script:
      name: checking prev step
      code: |
       cat manifests/weblogic-operator.yaml
       docker ps
       docker info

push-release:
 steps:
   - internal/docker-push:
      name: push the operator image to repo
      username: $QUAY_IO_USERNAME
      password: $QUAY_IO_PASSWORD
      repository: quay.io/fmwplt/weblogic-operator
      tag: $WERCKER_GIT_BRANCH-wercker-$WERCKER_GIT_COMMIT
      entrypoint: "/weblogic-operator"
      registry: https://quay.io